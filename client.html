<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealtimeConnect Meeting + Chat</title>
    <!-- Load Tailwind CSS from the compiled file -->
    <link rel="stylesheet" href="dist/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --sidebar-width: 320px;
        }
        
        /* Custom Variables and Theme (inherited from style.css but kept for reference) */
        :root {
            --background: 220 12% 12%; /* discord-darkest */
            --foreground: 220 12% 87%; /* discord-light */
            --sidebar: 220 14% 17%; /* discord-darker */
            --sidebar-border: 220 14% 10%; /* almost black */
            --accent: 236 60% 65%; /* discord-blue */
        }

        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            display: grid;
            grid-template-columns: 1fr var(--sidebar-width);
            height: 100vh;
            overflow: hidden;
            transition: grid-template-columns 0.3s ease;
        }
        
        body.chat-hidden {
            grid-template-columns: 1fr 0;
        }
        
        #chat-sidebar {
            width: var(--sidebar-width);
            background-color: hsl(var(--sidebar));
            border-left: 1px solid hsl(var(--sidebar-border));
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }
        
        body.chat-hidden #chat-sidebar {
            width: 0;
            border-left: none;
        }
        
        #chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid hsl(var(--sidebar-border));
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message-input-area {
            padding: 1rem;
            border-top: 1px solid hsl(var(--sidebar-border));
        }

        /* Video Grid Specific Styles */
        #video-grid-wrapper {
            flex-grow: 1;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #video-grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }

        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            grid-auto-rows: 200px;
            gap: 1rem;
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 0.5rem; /* Space for scrollbar */
        }

        .video-container {
            background-color: hsl(220 12% 10%);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .video-label {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 10;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }
            #chat-sidebar {
                position: fixed;
                bottom: 0;
                right: 0;
                width: 100%;
                height: 50%;
                z-index: 50;
                border-top: 1px solid hsl(var(--sidebar-border));
            }
            body.chat-hidden #chat-sidebar {
                height: 0;
                transition: height 0.3s ease;
            }
            #video-grid {
                grid-template-columns: 1fr;
                grid-auto-rows: 250px;
                gap: 0.5rem;
            }
            .video-controls-bar {
                padding: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            .video-controls-bar button {
                margin: 0.25rem;
            }
            #meeting-id-area {
                flex-direction: column;
            }
            #meeting-id-area > * {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Main Content Area (Video) -->
    <main id="video-main-content">
        <!-- Lobby/Pre-Meeting View -->
        <div id="lobby-view" class="h-full w-full flex flex-col items-center justify-center p-8 text-center" style="display: flex;">
            <h1 class="text-3xl font-bold mb-6 text-white">Start or Join a RealtimeConnect Meeting</h1>
            
            <!-- Meeting ID Input Area -->
            <div id="meeting-id-area" class="flex w-full max-w-xl space-x-2 mb-4">
                <input type="text" id="meetingIdInput" placeholder="Enter Meeting ID (e.g., QwErTy12)"
                       class="flex-grow p-3 rounded-lg bg-discord-darker text-discord-light border border-discord-dark focus:border-discord-blue focus:ring-1 focus:ring-discord-blue">
                <button id="joinMeetingBtn" class="btn btn-primary bg-discord-green hover:bg-opacity-90">
                    <i class="fa-solid fa-video"></i> Join Meeting
                </button>
            </div>
            
            <!-- Global and Random ID Buttons -->
            <div class="flex space-x-4">
                 <button id="startGlobalMeetingBtn" class="btn btn-primary bg-discord-blue">
                    <i class="fa-solid fa-globe"></i> Start Global Meeting
                </button>
                <button id="generateRandomBtn" class="btn bg-gray-600 text-white hover:bg-gray-700">
                    <i class="fa-solid fa-shuffle"></i> Generate Random ID
                </button>
            </div>

            <p class="text-gray-400 mt-4 text-sm">Or click "Start Global Meeting" to join a public room.</p>
            <p id="error-message" class="text-discord-red mt-4 font-semibold" style="display: none;"></p>
        </div>

        <!-- Meeting View -->
        <div id="meeting-view" class="h-full w-full flex flex-col" style="display: none;">
            
            <div id="video-grid-wrapper">
                <div id="video-grid-header">
                    <h2 class="text-xl font-semibold text-white">
                        Meeting ID: <span id="currentMeetingId" class="text-discord-blue"></span>
                    </h2>
                    <button id="toggleChatBtn" class="btn bg-gray-700 text-white hover:bg-gray-600 text-sm p-2">
                        <i class="fa-solid fa-message"></i> Toggle Chat
                    </button>
                </div>

                <div id="video-grid">
                    <!-- Local video stream will be added here -->
                </div>
            </div>

            <!-- Controls Bar -->
            <div class="video-controls-bar flex items-center justify-center p-4 bg-discord-darker shadow-xl space-x-4">
                <button id="micBtn" class="control-btn active bg-discord-blue hover:bg-discord-blue/80">
                    <i class="fa-solid fa-microphone"></i> Mic On
                </button>
                <button id="videoBtn" class="control-btn active bg-discord-blue hover:bg-discord-blue/80">
                    <i class="fa-solid fa-video"></i> Video On
                </button>
                <button id="screenShareBtn" class="control-btn bg-gray-600 hover:bg-gray-700">
                    <i class="fa-solid fa-desktop"></i> Share Screen
                </button>
                <button id="leaveBtn" class="control-btn bg-discord-red hover:bg-discord-red/80">
                    <i class="fa-solid fa-phone-slash"></i> Leave Meeting
                </button>
            </div>
        </div>
    </main>

    <!-- Sidebar (Chat) -->
    <aside id="chat-sidebar">
        <div id="chat-header">
            <h2 class="text-xl font-semibold">Text Chat</h2>
            <button id="signOutBtn" class="btn bg-gray-600 text-white hover:bg-gray-700 text-sm p-2">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
            </button>
        </div>

        <div id="chat-messages">
            <!-- Messages will appear here -->
        </div>

        <div class="message-input-area">
            <input type="text" id="chatInput" placeholder="Send a message..."
                   class="w-full px-4 py-2 bg-discord-darkest text-discord-light rounded-md border-none focus:outline-none focus:ring-2 focus:ring-discord-blue">
        </div>
    </aside>

    <script>
        // --- Global State ---
        let username = 'Guest'; 
        let currentMeetingId = '';
        let localStream = null;
        let peerConnections = {}; // Stores all RTCPeerConnections: {peerId: RTCPeerConnection}
        let ws = null; // WebSocket for chat

        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let isScreenShareEnabled = false;
        
        const videoGrid = document.getElementById('video-grid');
        const lobbyView = document.getElementById('lobby-view');
        const meetingView = document.getElementById('meeting-view');
        const meetingIdInput = document.getElementById('meetingIdInput');
        const currentMeetingIdEl = document.getElementById('currentMeetingId');
        const errorMessageEl = document.getElementById('error-message');

        // --- Utility Functions ---

        /** Shows a message in the error area */
        function displayError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.style.display = 'block';
            setTimeout(() => {
                errorMessageEl.style.display = 'none';
            }, 5000);
        }

        /** Creates a video element container for a stream */
        function createVideoElement(stream, peerId, label) {
            const containerId = 'video-container-' + peerId;
            let container = document.getElementById(containerId);

            if (container) {
                // If container already exists, just update the stream
                const videoEl = container.querySelector('video');
                if (videoEl) videoEl.srcObject = stream;
                return container;
            }

            container = document.createElement('div');
            container.id = containerId;
            container.classList.add('video-container');

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true; // Important for mobile

            const labelEl = document.createElement('span');
            labelEl.classList.add('video-label');
            labelEl.textContent = label;

            container.appendChild(video);
            container.appendChild(labelEl);
            videoGrid.appendChild(container);

            // Handle the aspect ratio for remote videos (auto-adjust size)
            video.onloadedmetadata = () => {
                // Ensure video starts playing (required for mobile/autoplay rules)
                video.play().catch(e => console.error("Video playback failed:", e));
            };
            
            return container;
        }
        
        /** Removes a video element by peer ID */
        function removeVideoElement(peerId) {
            const containerId = 'video-container-' + peerId;
            const container = document.getElementById(containerId);
            if (container) {
                // Clean up video stream object
                const videoEl = container.querySelector('video');
                if (videoEl && videoEl.srcObject) {
                    videoEl.srcObject = null;
                }
                container.remove();
                console.log('Removed video element for peer:', peerId);
            }
        }

        // --- Server & Auth Functions ---

        /** Fetches user info and sets the global username */
        async function fetchUserInfo() {
            try {
                const response = await fetch('/api/userinfo');
                if (response.ok) {
                    const data = await response.json();
                    username = data.username;
                    console.log('Authenticated as:', username);
                } else {
                    console.error('Not authenticated. Redirecting.');
                    window.location = '/login';
                }
            } catch (e) {
                console.error('Error fetching user info:', e);
                window.location = '/login';
            }
        }

        // --- Chat Functions ---

        /** Connects to the WebSocket server for text chat */
        function connectChat() {
            // Use current location's protocol (http/https) and port, replace with ws/wss
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Assuming WS runs on the same port/host for simplicity
            const url = `${protocol}//${window.location.host}/ws`; 

            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log("Chat already open.");
                return;
            }

            ws = new WebSocket(url);

            ws.onopen = () => {
                console.log('Chat WebSocket connected.');
                // Send username immediately after connection
                ws.send(username);
            };

            ws.onmessage = (event) => {
                appendChatMessage(event.data);
            };

            ws.onclose = () => {
                console.warn('Chat WebSocket disconnected.');
                // Simple auto-reconnect logic
                setTimeout(connectChat, 5000); 
            };

            ws.onerror = (error) => {
                console.error('Chat WebSocket error:', error);
            };
        }
        
        /** Sends a chat message */
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                input.value = '';
            }
        }

        /** Appends a message to the chat window */
        function appendChatMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', 'text-sm');

            const parts = message.split(': ', 2);
            if (parts.length === 2) {
                const userSpan = document.createElement('span');
                userSpan.classList.add('username', 'font-medium', 'text-discord-blue');
                userSpan.textContent = parts[0];

                const contentSpan = document.createElement('span');
                contentSpan.classList.add('content', 'text-discord-light');
                contentSpan.textContent = ': ' + parts[1];
                
                messageEl.appendChild(userSpan);
                messageEl.appendChild(contentSpan);
            } else {
                // System messages
                messageEl.classList.add('text-gray-400', 'italic');
                messageEl.textContent = message;
            }
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
        }


        // --- WebRTC Functions ---

        /** Gets local media (video and audio) */
        async function getLocalMedia(videoEnabled = true, audioEnabled = true) {
            try {
                // If stream already exists, stop existing tracks
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: videoEnabled,
                    audio: audioEnabled
                });
                console.log('Local media stream acquired.');
                // Add local stream to the grid
                createVideoElement(localStream, 'local', `${username} (You)`);
                return true;
            } catch (error) {
                console.error('Error accessing media devices:', error);
                displayError("Failed to access camera/mic. Please ensure they are allowed and connected.");
                return false;
            }
        }

        /** Creates the WebRTC Peer Connection with the server relay. */
        async function createPeerConnection(stream) {
            const pc = new RTCPeerConnection({
                // Using Google's public STUN servers for NAT traversal
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            // 1. Add local tracks to the connection
            stream.getTracks().forEach(track => {
                pc.addTrack(track, stream);
            });

            // 2. Handle remote tracks (streams coming back from the relay/server)
            pc.ontrack = (event) => {
                console.log('Remote track received:', event.track.kind);
                // The server acts as a relay, so the stream we receive here is the 
                // combined audio/video feed from all other users.
                const remotePeerId = 'remote-relay'; 
                createVideoElement(event.streams[0], remotePeerId, 'Relay Feed (Others)');
            };

            // 3. Create the Offer
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Wait for ICE gathering to complete before sending the offer (best practice for aiortc)
            await new Promise(resolve => {
                if (pc.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    pc.onicegatheringstatechange = () => {
                        if (pc.iceGatheringState === 'complete') {
                            resolve();
                        }
                    };
                }
            });

            // 4. Send Offer to server and get Answer
            const response = await fetch('/offer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sdp: pc.localDescription.sdp,
                    type: pc.localDescription.type,
                    // Note: meetingId is included for future room implementation
                    meetingId: currentMeetingId 
                })
            });

            if (!response.ok) {
                throw new Error('Server failed to process SDP offer.');
            }

            const data = await response.json();
            const remoteDesc = new RTCSessionDescription(data);
            await pc.setRemoteDescription(remoteDesc);
            
            const peerId = data.id;
            peerConnections[peerId] = pc;
            console.log(`WebRTC Peer Connection established with server. Peer ID: ${peerId}`);
        }
        
        /** Starts the meeting flow (gets media, starts WebRTC, switches view) */
        async function startMeeting(meetingId) {
            currentMeetingId = meetingId;
            currentMeetingIdEl.textContent = meetingId;
            lobbyView.style.display = 'none';
            meetingView.style.display = 'flex';
            
            // 1. Get Media
            const mediaReady = await getLocalMedia(isVideoEnabled, isAudioEnabled);
            if (mediaReady) {
                // 2. Start WebRTC connection
                await createPeerConnection(localStream);
            }
            
            // 3. (Re)connect chat
            connectChat();
        }

        /** Ends the WebRTC call and resets state */
        function endCall() {
            console.log('Ending call and closing connections...');

            // 1. Stop all local tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // 2. Close all peer connections
            for (const peerId in peerConnections) {
                peerConnections[peerId].close();
                delete peerConnections[peerId];
            }

            // 3. Close chat websocket
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // 4. Clear all video elements and remote streams
            videoGrid.innerHTML = '';
            
            // Reset state
            isVideoEnabled = true;
            isAudioEnabled = true;
            isScreenShareEnabled = false;
            updateMediaButtons();
            
            // Switch back to lobby view
            meetingView.style.display = 'none';
            lobbyView.style.display = 'flex';
        }

        /** Updates the visual state of the media control buttons */
        function updateMediaButtons() {
            const micBtn = document.getElementById('micBtn');
            const videoBtn = document.getElementById('videoBtn');
            const screenBtn = document.getElementById('screenShareBtn');

            // Mic Button
            micBtn.classList.toggle('bg-discord-blue', isAudioEnabled);
            micBtn.classList.toggle('hover:bg-discord-blue/80', isAudioEnabled);
            micBtn.classList.toggle('bg-discord-red', !isAudioEnabled);
            micBtn.classList.toggle('hover:bg-discord-red/80', !isAudioEnabled);
            micBtn.innerHTML = isAudioEnabled 
                ? '<i class="fa-solid fa-microphone"></i> Mic On' 
                : '<i class="fa-solid fa-microphone-slash"></i> Muted';
            
            // Video Button
            videoBtn.classList.toggle('bg-discord-blue', isVideoEnabled);
            videoBtn.classList.toggle('hover:bg-discord-blue/80', isVideoEnabled);
            videoBtn.classList.toggle('bg-discord-red', !isVideoEnabled);
            videoBtn.classList.toggle('hover:bg-discord-red/80', !isVideoEnabled);
            videoBtn.innerHTML = isVideoEnabled 
                ? '<i class="fa-solid fa-video"></i> Video On' 
                : '<i class="fa-solid fa-video-slash"></i> Video Off';
            
            // Screen Share 
            screenBtn.classList.toggle('bg-discord-green', isScreenShareEnabled);
            screenBtn.classList.toggle('hover:bg-discord-green/80', isScreenShareEnabled);
            screenBtn.classList.toggle('bg-gray-600', !isScreenShareEnabled);
            screenBtn.classList.toggle('hover:bg-gray-700', !isScreenShareEnabled);
        }

        /** Toggles the local microphone */
        function toggleMic() {
            if (!localStream) return;
            isAudioEnabled = !isAudioEnabled;
            localStream.getAudioTracks().forEach(track => track.enabled = isAudioEnabled);
            updateMediaButtons();
        }

        /** Toggles the local video feed */
        function toggleVideo() {
            if (!localStream) return;
            isVideoEnabled = !isVideoEnabled;
            localStream.getVideoTracks().forEach(track => track.enabled = isVideoEnabled);
            updateMediaButtons();
        }
        
        /** Toggles screen sharing (simplified stub) */
        async function toggleScreenShare() {
            isScreenShareEnabled = !isScreenShareEnabled;
            updateMediaButtons();
            
            if (isScreenShareEnabled) {
                 displayError("Screen sharing is active. Full track replacement not implemented in this version.");
            } else {
                 displayError("Screen sharing stopped.");
            }
        }
        
        /** Sign out (logs out server-side and redirects to login) */
        async function signOut() {
            endCall(); // Ensure all media/connections are closed first
            try {
                await fetch('/logout');
            } catch (e) {
                console.error('Error while logging out', e);
            }
            window.location = '/login';
        }

        // --- Event Listeners and Initialization ---

        document.getElementById('joinMeetingBtn').addEventListener('click', () => {
            const id = meetingIdInput.value.trim();
            if (id) {
                startMeeting(id);
            } else {
                displayError("Please enter a Meeting ID.");
            }
        });

        document.getElementById('startGlobalMeetingBtn').addEventListener('click', () => {
            // Use a fixed, well-known ID for the global public room
            startMeeting('GLOBAL-ROOM');
        });

        document.getElementById('generateRandomBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/random_id');
                const data = await response.json();
                meetingIdInput.value = data.meeting_id;
            } catch (e) {
                console.error('Failed to generate random ID:', e);
                displayError("Failed to generate a random ID from the server.");
            }
        });

        document.getElementById('chatInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        document.getElementById('toggleChatBtn').addEventListener('click', () => {
            document.body.classList.toggle('chat-hidden');
        });

        document.getElementById('micBtn').addEventListener('click', toggleMic);
        document.getElementById('videoBtn').addEventListener('click', toggleVideo);
        document.getElementById('screenShareBtn').addEventListener('click', toggleScreenShare);
        document.getElementById('leaveBtn').addEventListener('click', endCall);
        document.getElementById('signOutBtn').addEventListener('click', signOut);


        /** Main initialization function */
        window.onload = async () => {
            // 1. Authenticate user and get username
            await fetchUserInfo();
            
            // 2. Check for meeting ID in URL on load
            const urlParams = new URLSearchParams(window.location.search);
            const initialId = urlParams.get('room');
            
            if (initialId) {
                // If a room ID is present, pre-fill and auto-join
                meetingIdInput.value = initialId;
                await startMeeting(initialId);
            }
            
            // Initialize buttons visual state
            updateMediaButtons();
        };

    </script>
</body>
</html>